---
title: "PlotWF" 
author: "Author: Daniela Cassol (danielac@ucr.edu) and Thomas Girke (thomas.girke@ucr.edu)"
date: "Last update: `r format(Sys.time(), '%d %B, %Y')`" 
output:
  BiocStyle::html_document:
    toc_float: true
    code_folding: show
package: systemPipeR
vignette: |
  %\VignetteEncoding{UTF-8}
  %\VignetteIndexEntry{PlotWF}
  %\VignetteEngine{knitr::rmarkdown}
fontsize: 14pt
editor_options: 
  chunk_output_type: console
---

SPR workflows can be visualized with the `plotWF` (or change to a name you like Dani)
function. This function will make a plot of selected workflow instance and following 
information is displayed on the plot: 1. workflow structure (dependency graphs between 
different steps); 2. Workflow step status, i.e. success, fail, pending; 3. Sample 
status and statistics; 4. workflow timing: start, end and duration time. 

## create workflow instance 
This step in internal for now. Dani you want to replace this step with load the 
WF from a SAL object. Here I use the internal `parseRmd` function to load the WF
structure and save as df to a file for demo. It is easier to see if I change certain 
steps and remake a new plot. You can still use this df to demo in formal vignette but 
depends on how you want users to make the workflow plot.

1. they use this function from S4 level, like `plotSAL(sal, ...)`
2. SAL return this df and use S3 level function to plot: `p <- preparePlot(sal); plotWF(p)`

The plotting function is built on `htmlwidgets` skeleton, so it requires the data, 
javascripts and other resources to be stored inside a package. I created this 
`systemPipeR1` package to test. Later, you want to copy all files in `inst` to SPR
and change all key words `systemPipeR1` to `systemPipeR`. 

```{r}
library(systemPipeR)
```

```{r eval=TRUE}
wf_demo <- system.file("extdata", "wf_demo.Rmd", package = "systemPipeR")
file.exists(wf_demo)
# wf_demo <- "../inst/extdata/wf_demo.Rmd"
df <-  systemPipeR:::parseRmd(wf_demo) # you can load from Rmd
```

```{r}
plotWF
```


```{r }
# df <- tibble::as_tibble(readRDS("wf_df.rds")) # or use a pre-saved structure
#DT::datatable(df, width = "100%", options = list(scrollX = TRUE))
```


## Basic behavior 
If no argument is provided, the basic plot will automatically detect width, height, 
layout, plot method, branches, _etc_. 
```{r}
plotWF(df, verbose = FALSE)
```
### Color and text
On the plot, different colors and numbers indicate different status. This information 
can be found also in the plot legends.

**Shapes:**

- circular steps: pure R code steps
- rounded squares steps: `sysargs` steps, steps that will invoke commandline calls
- blue colored steps and arrows: main branch (see [main branch](#main-branch) section below)

**Step colors**

- black: pending steps
- <span class="text-success">Green</span>: successful steps
- <span class="text-danger">Green</span>: failed steps

**Number and colors**
<br>There are 4 numbers in the second row of each step, separated by `/`

- <span class="text-success">First No.</span>: number of passed samples
- <span class="text-warning">Second No.</span>: number of warning samples
- <span class="text-danger">Third No.</span>: number of erros samples
- <span style="color:blue;">Forth No.</span>: number of total samples

**Duration**
<br>This is shown after the sample information, as how long it took to run this step. 
Units are a few seconds (**s**), some minutes (**m**), or some hours (**h**). 

### on hover
When the mouse is hovering on each step, detailed information will be displayed.

### logging
The workflow steps will also become clickable if `in_log = TRUE`. This will create links 
for each step that navigate to corresponding log section in the SPR 
[workflow log file](change to page that introduce the log file). Normally this option 
is handled by SPR log file generating function to create this plot on top of the log file,
so when a certain step is click, it will navigate to the detailed section down the page. 
Here is only an example to demo how the plot can be clickable (will not navigate you to 
anywhere). Visit [this page](Add the link Dani) to see a real example. 

```{r}
plotWF(df, in_log = TRUE)
```


## Plot method
The default plotting method is svg. It means the plot is generated by svg embedding. 
Sometimes certain browsers may not display svg correctly. In this case, the other option 
is to use `png` to embed the plot. However, you will **lose hovering, clicking and some** 
**responsiveness** (plot auto resizing ability) of the plot. 

```{r}
plotWF(df, plot_method = "png")
```


## Rstudio
By default, even if you are working inside Rstudio the plot is **not displayed in Rstudio viewer**. 
This is because the workflow steps will be too small inside Rstudio viewer too 
see the details. We recommend to view it in a larger space, so by default it will 
open up your web browser to display it. You can enforce `rstudio = TRUE` to see it 
in Rstudio Viewer. 

```{r}
plotWF(df, rstudio = TRUE)
```


## Responsiveness
This is a term often used in web development. It means will the plot resize itself 
if the user resize the document window? By default, `plotWF` will be responsive, 
meaning it will fit current window container size and adjust the size once the window 
size has changed. To always display the full sized plot, use `responsive = FALSE`,
useful for embedding the plot in a full-screen mode.

<div style="height: 500px">
```{r}
plotWF(df, responsive = FALSE)
```
</div>

For the plot above, you need to scroll to see the plot.


## layout
There a few different layout you can choose. There is no best layout. It all depends 
on the workflow structure you have. The default is `compact` but we recommend you 
to try different layouts to find the best fitting one. 

- `compact`: try to plot steps as close as possible.
- `vertical`: main branch will be placed vertically and side branches will be placed
  on the same horizontal level and sub steps of side branches will be placed
  vertically.
- `horizontal`: main branch is placed horizontally and side branches and sub
  steps will be placed vertically.
- `execution`: a linear plot to show the workflow execution order of all steps.

**vertical**
```{r}
plotWF(df, layout = "vertical", height = "600px")
```
The plot is very long, use `height` to make it smaller.

**horizontal**
```{r}
plotWF(df, layout = "horizontal")
```

**execution**
```{r}
plotWF(df, layout = "execution", height = "600px", responsive = FALSE)
```
The plot is very long but if we use `height` to limit to a smaller size, details are 
hard to see. Then it will be good to use `height` and `responsive = FALSE` together. 

## Main branch 
From the plots above, you can that there are many steps which do not connect to any 
other steps. These dead-ends are called ending steps. If we connect the first step,
steps in between and these ending step, this will become a branch. Imagine the workflow is 
a upside-down tree structure and the root is the first step. Therefore, there are 
many possible ways to connect the workflow. For the convenience of plotting, we 
introduce a concept of _"main branch"_, meaning one of the possible connecting 
strategies that will be placed at the center of the plot. Other steps that are not 
in this major branch will surround this major space. 

This main branch will not impact the `compact` layout so much but will have a huge 
effect on `horizontal` and `vertical` layouts. 

The plotting function has an algorithm that will automatically choose a best branch for 
you by default. In simple words, it favors: a. branches that connect first and last step;
b. as long as possible. 

You can also choose a branch you want by `branch_method = "choose"`. It will first 
list all possible branches, and then give you a prompt to ask for your favorite branch. 
Here, for rendering the Rmarkdown, we cannot have a prompt, so we use a second argument 
in combination, `branch_no = x` to directly choose a branch and skip the prompt. Also, 
we use the `verbose = TRUE` to imitate the branch listing in console. In a real case, 
you only need `branch_method = "choose"`.

Watch closely how the plot change by choosing different branches. Here we use `vertical`
layout to demo. Remember, the main branch is marked in blue. 

```{r collapse=TRUE}
plotWF(df, layout = "vertical", branch_method = "choose", branch_no = 1, verbose = TRUE)
```

Home of UCR's HPCC
ï¿¼

```{r}
plotWF(df, layout = "vertical", branch_method = "choose", branch_no = 4)
```


### Unmark main branch 
The _main branch_ concept may not represent the main workflow. It is introduced 
for the convenience of plotting. Most times by auto detecting, it will find the 
major steps in a workflows, sometimes it does not. It depends on how the users 
design the workflow. If you think this is not a good representation, you can mute it 
by `mark_main_branch = FALSE`. You will no longer see the blue-colored steps on 
plot and on legends. 

```{r}
plotWF(df, mark_main_branch = FALSE, height = "500px")
```

## Legends 
The legend can also be removed by `show_legend = FALSE`
```{r}
plotWF(df, show_legend = FALSE, height = "500px")
```

## Output formats 
There are current three output formats: `"html"` and `"dot"`, `"dot_print"`. If first 
two were chosen, you also need provide a path `out_path` to save the file. 

- html: a single html file contains the plot.
- dot: a DOT script file with the code to reproduce the plot in a [graphiz](https://graphviz.org/)
  DOT engine. 
- dot_print: directly cat the dot script to console. 

```{r}
plotWF(df, out_format = "html", out_path = "example_out.html")
file.exists("example_out.html")
```


```{r}
plotWF(df, out_format = "dot", out_path = "example_out.dot")
cat(readLines("example_out.dot")[1:5], sep = "\n")
```

```{r eval=FALSE}
plotWF(df, out_format = "dot_print") # not run here, takes too much space, try in your console
```


### Save to a static image file
Some users may want to save the plot to a static image, like `.png` format. We will 
need do some extra work to save the file. The reason we cannot directly save it to 
a png file is the plot is generated in real-time by a browser javascript engine. It 
requires one type of javascript engine, like Chrome, MS Edge, Viewer in Rstudio,
to render the plot before we can see it.

#### Interactive 

- If you are working in Rstudio, you can use the `export` button in the viewer to save 
an image file. 
- If you are working from commandline, use `plot_method = 'png'` to first ask the browser
  to generate a png and then when you see the image, you can right-click to save it. 
  
#### Non-interactive
If you cannot have an interactive session, like submitting a job to a cluster, 
but still want the png, we recommend to use the {[webshot2](https://github.com/wch/webshot)}
package to screenshot the plot. It runs headless Chrome in the backend (which has a javascript engine).

Install the package 
```{r eval=FALSE}
# remotes::install_github("rstudio/webshot2")
```

Save to html first
```{r eval=FALSE}
#plotWF(df, out_format = "html", out_path = "example_out.html")
# file.exists("example_out.html")
```

Use webshot2 to save the image
```{r}
# webshot2::webshot("example_out.html", "example_out.png")
```


